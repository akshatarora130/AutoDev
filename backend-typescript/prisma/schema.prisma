generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(uuid())
  username    String   @unique
  githubId    String   @unique
  email       String?
  avatarUrl   String?
  githubToken String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projects Project[]

  @@map("users")
}

model Project {
  id          String   @id @default(uuid())
  userId      String
  name        String
  description String?
  source      String
  githubUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  files       File[]
  stories     Story[]
  logs        AgentLog[]
  deployments Deployment[]

  @@index([userId])
  @@map("projects")
}

model File {
  id        String   @id @default(uuid())
  projectId String
  path      String
  content   String   @db.Text
  encoding  String   @default("utf-8")
  size      Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  codeArtifacts CodeArtifact[]

  @@unique([projectId, path])
  @@index([projectId])
  @@map("files")
}

model Story {
  id           String    @id @default(uuid())
  projectId    String
  title        String
  description  String    @db.Text
  priority     String    @default("medium")
  status       String    @default("pending")
  // Status values: pending | dividing | reviewing | tasks_ready | generating | 
  //                code_review | testing | deploying | completed | failed | cancelled

  // Selection tracking
  selectedAt   DateTime?
  selectedBy   String?   // "priority" | "llm_tiebreaker"
  llmReasoning String?   @db.Text

  // Completion tracking
  completedAt  DateTime?
  previewUrl   String?   // Deployment URL after Phase 6

  // Error tracking
  failedAt     DateTime?
  failedPhase  String?   // Which phase failed
  failedReason String?   @db.Text

  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@index([projectId])
  @@index([status])
  @@index([priority])
  @@map("stories")
}

model Task {
  id               String   @id @default(uuid())
  storyId          String
  title            String
  description      String   @db.Text
  type             String   // frontend | backend | database | integration
  priority         Int      @default(0)
  status           String   @default("pending")
  // Status: pending | reviewed | subdivided | in_progress | code_generated |
  //         code_approved | tests_generated | tests_passed | deployed | failed

  // Review tracking
  reviewedAt       DateTime?
  reviewNotes      String?  @db.Text

  // Subdivision tracking
  parentTaskId     String?

  dependencies     Json?    // Array of task IDs this depends on
  agentAssignments Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  story         Story          @relation(fields: [storyId], references: [id], onDelete: Cascade)
  parentTask    Task?          @relation("TaskSubdivision", fields: [parentTaskId], references: [id])
  childTasks    Task[]         @relation("TaskSubdivision")
  codeArtifacts CodeArtifact[]
  testResults   TestResult[]
  logs          AgentLog[]

  @@index([storyId])
  @@index([status])
  @@index([priority])
  @@index([parentTaskId])
  @@map("tasks")
}

model CodeArtifact {
  id        String   @id @default(uuid())
  taskId    String
  fileId    String?
  agentType String   // frontend_gen | backend_gen | database_gen | code_reviewer
  content   String   @db.Text
  status    String   @default("pending") // pending | approved | rejected

  // Version tracking
  version   Int      @default(1)
  isLatest  Boolean  @default(true)
  parentId  String?  // Previous version's ID for version chain

  // Review info
  reviewNotes String?  @db.Text
  reviewedAt  DateTime?
  reviewedBy  String?  // Agent that reviewed this artifact

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task     Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  file     File?         @relation(fields: [fileId], references: [id], onDelete: SetNull)
  parent   CodeArtifact? @relation("ArtifactVersions", fields: [parentId], references: [id])
  children CodeArtifact[] @relation("ArtifactVersions")

  @@index([taskId])
  @@index([status])
  @@index([version])
  @@index([isLatest])
  @@map("code_artifacts")
}

model TestResult {
  id        String   @id @default(uuid())
  taskId    String
  testType  String
  status    String
  coverage  Float?
  results   Json?
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([status])
  @@map("test_results")
}

model AgentLog {
  id        String   @id @default(uuid())
  projectId String
  taskId    String?
  agentType String
  event     String
  data      Json?
  timestamp DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task    Task?   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([taskId])
  @@index([timestamp])
  @@map("agent_logs")
}

model Deployment {
  id         String   @id @default(uuid())
  projectId  String
  status     String   @default("pending")
  previewUrl String?
  logs       String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@map("deployments")
}

model FileSnapshot {
  id        String   @id @default(uuid())
  storyId   String
  filePath  String
  content   String   @db.Text
  existed   Boolean  @default(true)  // false if file didn't exist before (was created)
  createdAt DateTime @default(now())

  @@index([storyId])
  @@index([storyId, filePath])
  @@map("file_snapshots")
}
